---
title: "Sweden 1990 tax"
output: pdf_document
---

```{r}
library(magrittr)
library(tidyverse)
library(gmm)
library(Synth)
library(splines)
library(scales)
library(ggplot2)
library(ggpubr)

d<-foreign::read.dta("data/carbontax_data.dta")
d%<>%arrange(country,year)
```

# Effect on CO2_transport_capita

```{r}
excluded<-NULL
d1<-d%>%select(Countryno,country,year,CO2_transport_capita)
model<-lm(CO2_transport_capita~poly(year,2),data=d1%>%filter(country!="Sweden"))
d1%<>%mutate(CO2_transport_capita.resid=CO2_transport_capita-predict(model,newdata=d1))

Y<-d1%>%filter(country=="Sweden")%>%pull(CO2_transport_capita.resid)

all.years<-unique(d1$year)
t.shift<-min(d1$year)-1
T<-n_distinct(d1$year)
t<-1:T
T0<-1989-1960+1


DR<-function(data){
    T<-data$T
    T0<-data$T0
    t<-data$t
    nW<-ncol(data$W)
    nZ<-ncol(data$Z[,Z.countries,drop=FALSE])
    
    evalh<-function(theta,data){
        as.numeric(cbind(1,data$W)%*%theta[1:(nW+1)])
    }
    evalq<-function(theta,data){
        as.numeric(exp(cbind(1,data$Z[,Z.countries,drop=FALSE])%*%theta[(nW+2):(nW+nZ+2)]))
    }
    gh<-cbind(1,data$Z)
    ngh<-ncol(gh)
    gq<-cbind(1,data$W)
    ngq<-ncol(gq)
    
    g<-function(theta,data){
        h<-evalh(theta,data)
        q<-evalq(theta,data)
        
        g1<-(t<=T0)*(data$Y-h)*gh
        g2<-(t>T0)*(matrix(theta[(nW+nZ+3):(nW+nZ+ngq+2)],nrow=T,ncol=ngq,byrow=TRUE)-gq)
        g3<-(t<=T0)*(q*gq-matrix(theta[(nW+nZ+3):(nW+nZ+ngq+2)],nrow=T,ncol=ngq,byrow=TRUE))
        g4<-(t>T0)*(theta[nW+nZ+ngq+3]-(data$Y-h)+theta[nW+nZ+ngq+4])
        g5<-(t<=T0)*(theta[nW+nZ+ngq+4]-q*(data$Y-h))
        
        cbind(g1,g2,g3,g4,g5)
    }
    
    gradv<-function(theta,data){
        h<-evalh(theta,data)
        q<-evalq(theta,data)
        
        out<-matrix(0,ngh+2*ngq+2,nW+nZ+ngq+4)
        
        #g1
        out[1:ngh,1:(nW+1)]<--t(gh)%*%(cbind(1,data$W)*(t<=T0))/T
        
        #g2
        out[(ngh+1):(ngh+ngq),(nW+nZ+3):(nW+nZ+ngq+2)]<-diag((T-T0)/T,ngq)
        
        #g3
        out[(ngh+ngq+1):(ngh+2*ngq),(nW+nZ+3):(nW+nZ+ngq+2)]<-diag(-T0/T,ngq)
        M1<-t(gq)
        M2<-q*(t<=T0)*cbind(1,data$Z[,Z.countries,drop=FALSE])/T
        out[(ngh+ngq+1):(ngh+2*ngq),(nW+2):(nW+nZ+2)]<-M1%*%M2
        
        #g4
        out[ngh+2*ngq+1,nW+nZ+ngq+3]<-out[ngh+2*ngq+1,nW+nZ+ngq+4]<-(T-T0)/T
        out[ngh+2*ngq+1,1:(nW+1)]<-colMeans(cbind(1,data$W)*(t>T0))
        
        #g5
        out[ngh+2*ngq+2,nW+nZ+ngq+4]<-T0/T
        out[ngh+2*ngq+2,1:(nW+1)]<-colMeans(q*cbind(1,data$W)*(t<=T0))
        out[ngh+2*ngq+2,(nW+2):(nW+nZ+2)]<-colMeans(-q*(data$Y-h)*cbind(1,data$Z[,Z.countries,drop=FALSE])*(t<=T0))
        
        out
    }
    
    init.model.h<-lm(data$Y~.,data=as.data.frame(data$W),subset=t<=T0)
    init.alpha<-coef(init.model.h)
    
    init.model.q<-glm(I(t>T0)~.,data=as.data.frame(data$Z[,Z.countries,drop=FALSE]),family=binomial())
    init.beta<-coef(init.model.q)
    init.beta[1]<-init.beta[1]+log((T-T0)/T0)
    
    init.psi<-colMeans(gq[t>T0,,drop=FALSE])
    init.psi.minus<-mean(exp(cbind(1,data$Z[t<=T0,Z.countries,drop=FALSE])%*%init.beta)*(data$Y[t<=T0]-predict(init.model.h,newdata=as.data.frame(data$W[t<=T0,,drop=FALSE]))))
    init.phi<-mean(data$Y[t>T0]-predict(init.model.h,newdata=as.data.frame(data$W[t>T0,,drop=FALSE])))-init.psi.minus
    theta0<-c(init.alpha,init.beta,init.psi,init.phi,init.psi.minus)
    
    names(theta0)<-c(paste0("alpha",0:nW),paste0("beta",0:nZ),paste0("psi",1:ngq),"phi","psi-")
    
    model<-gmm(g=g,x=data,t0=theta0,gradv=gradv,wmatrix="ident",control=list(maxit=1e4),method="BFGS",vcov="iid")
    cat("Parameter estimate:\n")
    print(coef(model))
    cat("Summary of estimated q(Zt):\n")
    print(summary(evalq(coef(model),data)[t<=T0]))
    
    phi.hat=coef(model)["phi"]
    
    #vcov HAC
    var<-sandwich::vcovHAC(model)
    rownames(var)<-colnames(var)<-names(theta0)
    SE<-sqrt(var["phi","phi"])
    CI<-phi.hat+qnorm(c(.025,.975))*SE
    
    SC<-evalh(coef(model),data)
    
    gthetahat<-g(coef(model),data)
    autocors<-lapply(1:ncol(gthetahat),function(i){
        x<-acf(gthetahat[,i],plot=FALSE)
        x
    })
    cat("Entrywise autocorrelation of moment equation:\n")
    print(autocors)
    
    list(phi.hat=phi.hat,SE=SE,CI=CI,convergence=model$algoInfo$convergence,SC=SC)
}

PI.h<-function(data){
    T<-data$T
    T0<-data$T0
    t<-data$t
    nW<-ncol(data$W)
    
    evalh<-function(theta,data){
        as.numeric(cbind(1,data$W)%*%theta[1:(nW+1)])
        # as.numeric(cbind(data$W)%*%theta[1:nW])
    }
    gh<-cbind(1,data$Z)
    ngh<-ncol(gh)
    
    g<-function(theta,data){
        h<-evalh(theta,data)
        
        g1<-T/T0*(t<=T0)*(data$Y-h)*gh
        g2<-(t>T0)*(theta[nW+2]-(data$Y-h))
        
        cbind(g1,g2)
    }
    
    gradv<-function(theta,data){
        h<-evalh(theta,data)
        
        out<-matrix(0,ngh+1,nW+2)
        
        #g1
        out[1:ngh,1:(nW+1)]<--t(gh)%*%(cbind(1,data$W)*(t<=T0))/T0
        
        #g2
        out[ngh+1,nW+2]<-(T-T0)/T
        out[ngh+1,1:(nW+1)]<-colMeans((t>T0)*cbind(1,data$W))
        
        out
    }
    
    init.model.h<-lm(data$Y~.,data=as.data.frame(data$W),subset=t<=T0)
    init.alpha<-coef(init.model.h)
    init.phi<-mean(data$Y[t>T0]-predict(init.model.h,newdata=as.data.frame(data$W[t>T0,,drop=FALSE])))
    theta0<-c(init.alpha,init.phi)
    
    names(theta0)<-c(paste0("alpha",0:nW),"phi")
    
    model<-gmm(g=g,x=data,t0=theta0,gradv=gradv,wmatrix="ident",control=list(maxit=1e4),method="BFGS",vcov="iid")
    cat("Parameter estimate:\n")
    print(coef(model))
    
    phi.hat=coef(model)["phi"]
    
    #vcov HAC
    var<-sandwich::vcovHAC(model)
    rownames(var)<-colnames(var)<-names(theta0)
    SE<-sqrt(var["phi","phi"])
    CI<-phi.hat+qnorm(c(.025,.975))*SE
    
    SC<-evalh(coef(model),data)
    
    gthetahat<-g(coef(model),data)
    autocors<-lapply(1:ncol(gthetahat),function(i){
        x<-acf(gthetahat[,i],plot=FALSE)
        x
    })
    cat("Entrywise autocorrelation of moment equation:\n")
    print(autocors)
    
    list(phi.hat=phi.hat,SE=SE,CI=CI,convergence=model$algoInfo$convergence,SC=SC)
}



PI.q<-function(data){
    T<-data$T
    T0<-data$T0
    t<-data$t
    nZ<-ncol(data$Z[,Z.countries,drop=FALSE])
    
    evalq<-function(theta,data){
        as.numeric(exp(cbind(1,data$Z[,Z.countries,drop=FALSE])%*%theta[1:(nZ+1)]))
    }
    gq<-cbind(1,data$W)
    ngq<-ncol(gq)
    
    g<-function(theta,data){
        q<-evalq(theta,data)
        
        g1<-(t>T0)*(matrix(theta[(nZ+2):(nZ+ngq+1)],nrow=T,ncol=ngq,byrow=TRUE)-gq)
        g2<-(t<=T0)*(q*gq-matrix(theta[(nZ+2):(nZ+ngq+1)],nrow=T,ncol=ngq,byrow=TRUE))
        g3<-(t>T0)*(theta[nZ+ngq+2]-data$Y+theta[nZ+ngq+3])
        g4<-(t<=T0)*(theta[nZ+ngq+3]-q*data$Y)
        
        cbind(g1,g2,g3,g4)
    }
    
    gradv<-function(theta,data){
        q<-evalq(theta,data)
        
        out<-matrix(0,2*ngq+2,nZ+ngq+3)
        
        #g1
        out[1:ngq,(nZ+2):(nZ+ngq+1)]<-diag((T-T0)/T,ngq)
        
        #g2
        out[(ngq+1):(2*ngq),(nZ+2):(nZ+ngq+1)]<-diag(-T0/T,ngq)
        M1<-t(gq)
        M2<-q*(t<=T0)*cbind(1,data$Z[,Z.countries,drop=FALSE])/T
        out[(ngq+1):(2*ngq),1:(nZ+1)]<-M1%*%M2
        
        #g3
        out[2*ngq+1,nZ+ngq+2]<-out[2*ngq+1,nZ+ngq+3]<-(T-T0)/T
        
        #g4
        out[2*ngq+2,nZ+ngq+3]<-T0/T
        out[2*ngq+2,1:(nZ+1)]<-colMeans(-q*data$Y*cbind(1,data$Z[,Z.countries,drop=FALSE])*(t<=T0))
        
        out
    }
    
    init.model.q<-glm(I(t>T0)~.,data=as.data.frame(data$Z[,Z.countries,drop=FALSE]),family=binomial())
    init.beta<-coef(init.model.q)
    init.beta[1]<-init.beta[1]+log((T-T0)/T0)
    init.psi<-colMeans(gq[t>T0,,drop=FALSE])
    init.psi.minus<-mean(exp(cbind(1,data$Z[t<=T0,Z.countries,drop=FALSE])%*%init.beta)*data$Y[t<=T0])
    init.phi<-mean(data$Y[t>T0])-init.psi.minus
    theta0<-c(init.beta,init.psi,init.phi,init.psi.minus)
    
    names(theta0)<-c(paste0("beta",0:nZ),paste0("psi",1:ngq),"phi","psi-")
    
    model<-gmm(g=g,x=data,t0=theta0,gradv=gradv,wmatrix="ident",control=list(maxit=1e4),method="BFGS",vcov="iid")
    cat("Parameter estimate:\n")
    print(coef(model))
    cat("Summary of estimated q(Zt):\n")
    print(summary(evalq(coef(model),data)[t<=T0]))
    
    phi.hat=coef(model)["phi"]
    
    #vcov HAC
    var<-sandwich::vcovHAC(model)
    rownames(var)<-colnames(var)<-names(theta0)
    SE<-sqrt(var["phi","phi"])
    CI<-phi.hat+qnorm(c(.025,.975))*SE
    
    gthetahat<-g(coef(model),data)
    autocors<-lapply(1:ncol(gthetahat),function(i){
        x<-acf(gthetahat[,i],plot=FALSE)
        x
    })
    cat("Entrywise autocorrelation of moment equation:\n")
    print(autocors)
    
    list(phi.hat=phi.hat,SE=SE,CI=CI,convergence=model$algoInfo$convergence,SC=NA)
}

OLS<-function(data){
    T<-data$T
    T0<-data$T0
    nU<-data$nU
    t<-data$t
    treatment<<-as.numeric(t>T0)
    Y<<-data$Y
    W<<-data$W
    
    model<-gmm(g=Y~W+treatment,x=~W+treatment,wmatrix="ident",vcov="iid")
    cat("Parameter estimate:\n")
    print(coef(model))
    
    phi.hat<-coef(model)["treatment"]
    
    #vcov HAC
    var<-sandwich::vcovHAC(model)
    rownames(var)<-colnames(var)<-names(coef(model))
    SE<-sqrt(var["treatment","treatment"])
    CI<-phi.hat+qnorm(c(.025,.975))*SE
    
    SC<-as.numeric(cbind(1,data$W)%*%coef(model)[1:(ncol(data$W)+1)])
    
    gthetahat<-as.numeric((data$Y-cbind(1,data$W,as.numeric(t>T0))%*%coef(model)))*cbind(1,data$W,as.numeric(t>T0))
    autocors<-lapply(1:ncol(gthetahat),function(i){
        x<-acf(gthetahat[,i],plot=FALSE)
        x
    })
    cat("Entrywise autocorrelation of moment equation:\n")
    print(autocors)
    
    list(phi.hat=phi.hat,SE=SE,CI=CI,convergence=0,SC=SC)
}
```

## Original synthetic control

```{r}
X<-d1%>%filter(country!="Sweden")%>%select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix

dataprep.out <-
    dataprep(foo = d,
             predictors = c("GDP_per_capita" , "gas_cons_capita" , "vehicles_capita" ,
                            "urban_pop") ,
             predictors.op = "mean" ,
             time.predictors.prior = 1980:1989 ,
             special.predictors = list(
                 list("CO2_transport_capita" , 1989 , "mean"),
                 list("CO2_transport_capita" , 1980 , "mean"),
                 list("CO2_transport_capita" , 1970 , "mean")
             ),
             dependent = "CO2_transport_capita",
             unit.variable = "Countryno",
             unit.names.variable = "country",
             time.variable = "year",
             treatment.identifier = 13,
             controls.identifier = c(1:12, 14:15),
             time.optimize.ssr = 1960:1989,
             time.plot = 1960:2005
    )
synth.out <- synth(data.prep.obj = dataprep.out,
                   method = "All")
synth.out
Abadie.SC<-as.numeric(X%*%synth.out$solution.w)
(phi.hat<-mean(Y[t>T0]-Abadie.SC[t>T0]))
```

For proximal causal inference methods, I selected countries with weight $>0.1$ to be the donors.


```{r}
donors<-c("Belgium","Denmark","Greece","New Zealand")
W<-d1%>%filter(country %in% donors)%>%
    select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix
Z<-d1%>%filter(!(country %in% c("Sweden",donors,excluded)))%>%
    select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix
data<-list(t=t,W=W,Z=Z,Y=Y,T=T,T0=T0)
```

## OLS

```{r}
(OLS.result<-OLS(data))
```


## Outcome modeling

```{r}
(h.result<-PI.h(data))
```

## Iceland in $Z$

```{r}
Z.countries<-"Iceland"

(DR.Iceland.result<-DR(data))
(q.Iceland.result<-PI.q(data))
```

## Iceland & France

```{r}
Z.countries<-c("France","Iceland")

(DR.Iceland.France.result<-DR(data))
(q.Iceland.France.result<-PI.q(data))
```

## Iceland & France & Switzerland

```{r}
Z.countries<-c("France","Iceland","Switzerland")

(DR.Iceland.France.Switzerland.result<-DR(data))
(q.Iceland.France.Switzerland.result<-PI.q(data))
```


## Trajectory plot

```{r}
plot.d<-data.frame(year=data$t+t.shift)%>%
    mutate(`Abadie's SC`=Abadie.SC,DR=DR.Iceland.result$SC,`outcome bridge`=h.result$SC,DR2=DR.Iceland.France.result$SC,
           DR3=DR.Iceland.France.Switzerland.result$SC,
           # DR4=DR.result4$SC,
           OLS=OLS.result$SC)%>%
    pivot_longer(!year,names_to="method",values_to="outcome")%>%
    arrange(method,year)%>%
    mutate(Y=rep(data$Y,times=6))
colors<-hue_pal()(2)
ggplot(plot.d,aes(x=year,y=Y))+
    geom_line(color=colors[1],size=1,alpha=.5)+
    geom_line(aes(x=year,y=outcome),color=colors[2],linetype="longdash",size=1)+
    geom_vline(xintercept=data$T0+t.shift,linetype="dotted")+
    facet_wrap(~method,labeller="label_both")+
    ylab(expression(paste("Detrended  ",CO[2], " Emission")))+theme_bw()
ggsave("main_analysis.pdf",width=6,height=4)
```



# Placebo (in 1980) effect on CO2_transport_capita

```{r}
years.to.include<-1960:1989

d1%<>%filter(year %in% years.to.include)

Y<-d1%>%filter(country=="Sweden")%>%pull(CO2_transport_capita.resid)

T<-length(years.to.include)
t<-1:T
T0<-20
```

## Original synthetic control

```{r}
X<-d1%>%filter(country!="Sweden")%>%select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix

dataprep.out <-
    dataprep(foo = d,
             predictors = c("GDP_per_capita" , "gas_cons_capita" , "vehicles_capita" ,
                            "urban_pop") ,
             predictors.op = "mean" ,
             time.predictors.prior = 1970:1979 ,
             special.predictors = list(
                 list("CO2_transport_capita" , 1979 , "mean"),
                 list("CO2_transport_capita" , 1970 , "mean"),
                 list("CO2_transport_capita" , 1965 , "mean")
             ),
             dependent = "CO2_transport_capita",
             unit.variable = "Countryno",
             unit.names.variable = "country",
             time.variable = "year",
             treatment.identifier = 13,
             controls.identifier = c(1:12,14:15),
             time.optimize.ssr = 1960:1979,
             time.plot = 1960:1990
    )

synth.out <- synth(
    data.prep.obj = dataprep.out,
    method = "All"
)

synth.out
Abadie.SC<-as.numeric(X%*%synth.out$solution.w)
(phi.hat<-mean(Y[t>T0]-Abadie.SC[t>T0]))
```

```{r}
donors<-c("Belgium","Denmark","Greece","New Zealand")
W<-d1%>%filter(country %in% donors)%>%
    select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix
Z<-d1%>%filter(!(country %in% c("Sweden",donors,excluded)))%>%
    select(-Countryno,-CO2_transport_capita)%>%
    pivot_wider(names_from="country",values_from="CO2_transport_capita.resid")%>%
    arrange(year)%>%select(-year)%>%as.matrix
data<-list(t=t,W=W,Z=Z,Y=Y,T=T,T0=T0)
```

## OLS

```{r}
(OLS.result<-OLS(data))
```


## Outcome modeling

```{r}
(h.result<-PI.h(data))
```

## Iceland in $Z$

```{r}
Z.countries<-"Iceland"

(DR.Iceland.result<-DR(data))
(q.Iceland.result<-PI.q(data))
```

## Iceland & France

```{r}
Z.countries<-c("France","Iceland")

(DR.Iceland.France.result<-DR(data))
(q.Iceland.France.result<-PI.q(data))
```

## Iceland & France & Switzerland

```{r}
Z.countries<-c("France","Iceland","Switzerland")

(DR.Iceland.France.Switzerland.result<-DR(data))
(q.Iceland.France.Switzerland.result<-PI.q(data))
```


## Trajectory plot

```{r}
plot.d<-data.frame(year=data$t+t.shift)%>%
    mutate(`Abadie's SC`=Abadie.SC,DR=DR.Iceland.result$SC,`outcome bridge`=h.result$SC,DR2=DR.Iceland.France.result$SC,
           DR3=DR.Iceland.France.Switzerland.result$SC,
           OLS=OLS.result$SC)%>%
    pivot_longer(!year,names_to="method",values_to="outcome")%>%
    arrange(method,year)%>%
    mutate(Y=rep(data$Y,times=6))
colors<-hue_pal()(2)
ggplot(plot.d,aes(x=year,y=Y))+
    geom_line(color=colors[1],size=1,alpha=.5)+
    geom_line(aes(x=year,y=outcome),color=colors[2],linetype="longdash",size=1)+
    geom_vline(xintercept=data$T0+t.shift,linetype="dotted")+
    facet_wrap(~method,labeller="label_both")+
    ylab(expression(paste("Detrended ",CO[2], " Emission")))+theme_bw()
ggsave("placebo_analysis.pdf",width=6,height=4)
```
